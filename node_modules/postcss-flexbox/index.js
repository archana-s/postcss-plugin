var postcss = require('postcss');
var layouts = require('./flexbox-configs.js');

var appendProps = function(name, rule) {
  var props = layouts[name];
  for (var i=0; i<props.length; i++) {
    var prop = props[i].split(':')[0].trim();
    var value = props[i].split(':')[1].trim();
    rule.append(props[i]);
  }
};

module.exports = postcss.plugin('flexbox',
  function flexboxAdder(options) {
    return function (css) {
      options = options || {};

      css.walkRules(function (rule) {
        rule.walkDecls(function (decl, i) {
          var value = decl.prop;

          if (decl.prop === 'box') {
            appendProps(decl.prop, rule);
            var direction = decl.value.indexOf('horizontal') >= 0 ? 'horizontal':'vertical';
            var allValues = decl.value.replace(/\'|\"/g, "").split(' ');

            for (var i=0; i<allValues.length; i++) {
              var currValue = allValues[i].toLowerCase();

              if (currValue === direction) {
                if (allValues.indexOf('reverse') < 0) appendProps(direction, rule);
              } else {
                if (layouts['direction-specific-values'].indexOf(currValue) >= 0) {
                  appendProps(direction + '-' + currValue, rule);
                } else {
                  appendProps(currValue, rule);
                }
              }
            }
            rule.removeChild(decl);
          }
        });
      });
    }
  });
